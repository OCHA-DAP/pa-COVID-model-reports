---
output:  
  pdf_document: 
    md_extensions: +raw_attribute
    latex_engine: xelatex
    fig_caption: yes
  classoption: twocolumn
  extra_dependencies: xcolor
params:
  assignment_date: ''      
fontsize: 11pt
geometry: margin=0.6in
urlcolor: centreBlue
header-includes:
    - \usepackage{setspace}\singlespacing
    - \usepackage{colortbl}
    - \usepackage{caption}
    - \usepackage{wrapfig}
    - \usepackage{fontspec}
    - \setmainfont{Source Sans Pro}
    - \usepackage{fancyhdr}
    - \pagestyle{fancy}
    - \usepackage{float}
    - \captionsetup[figure]{labelformat=empty}
editor_options: 
  chunk_output_type: inline
---
\arrayrulecolor{white}
\definecolor{centreGreen}{HTML}{1bb580}
\definecolor{centreBlue}{HTML}{1f69b3}
\definecolor{withNPIColor}{HTML}{d9ead3}
\definecolor{noNPIColor}{HTML}{f4cccc}
\definecolor{withNPIFontColor}{HTML}{20aa6c}
\definecolor{noNPIFontColor}{HTML}{be0003}
\thispagestyle{fancy} 
\lhead{}
\chead{}
\rhead{} 
\lfoot{\fontsize{7}{7}\leavevmode\selectfont\textcolor{gray}{\thepage}}
\cfoot{}
\rfoot{\fontsize{7}{7}\leavevmode\selectfont\textcolor{gray}{The OCHA Centre for Humanitarian Data | Connecting people and data to improve lives}}
\renewcommand{\headrulewidth}{0pt} 
\renewcommand{\footrulewidth}{0.4pt}
\captionsetup[table]{labelformat=empty}

![](visual_assets/double_logo_header.jpg)


```{r key_messages, echo = FALSE}

# NOTE: each bullet point needs to start with a *, and there must be a blank line between bullet points. 
# There must also be a blank line at the beginning of the string.

key_messages_current_situation <- "

* **As of 1 March 2021 COVID-19 projections will no longer be produced on a bi-weekly basis but will be available on request. Please contact leonardo.milano@un.org for updated projections.**

* Per the WHO, a total of {who_current_cum_cases} cases and {who_current_cum_deaths} deaths have been reported to date. The current number of daily new cases stands at {who_current_newdaily_7daverage_cases} (7-day average).

* The number of active severe cases requiring hospitalization is estimated at {hospitalizations_current_LOW} - {hospitalizations_current_HI}.

* While some regions are on track for containment (green risk level), most are facing community spread (yellow risk level), while Bari, Nugaal, and Banadir are at the Tipping Point (red risk level). Of a particular concern is Banadir, with 224 cases per 100,000 people. More intense control efforts are needed (see section 2).

* We note the following measures as currently in place: limits on public gatherings (25% compliance). Please email us (leonardo.milano@un.org) if this information is inaccurate or incomplete as it affects the accuracy of projections.

* The data reported by the authorities suffers from severe gaps and displays significant variation from day-to-day. This might reflect challenges in data collection and/or batching where multiple days' worth of data are reported at once. For these reasons it is difficult to assess the stability of trends.
"   

key_messages_national_projections <- "

* In 4 weeks, we project that {npi_projected_deltas_cases_4w_LOW} - {npi_projected_deltas_cases_4w_HI} additional cases and {npi_projected_deltas_deaths_4w_LOW} - {npi_projected_deltas_deaths_4w_HI} additional deaths will be reported if current NPIs are maintained.
  
* Lifting the NPIs would lead to a significantly higher number of additional cases and deaths in 4 weeks: up to {no_npi_vs_npi_projected_deltas_cases_4W_MAX } more cases and up to {no_npi_vs_npi_projected_deltas_deaths_4W_MAX } more deaths (see sections 2 and 3 for details). Due to the lag between cases and deaths, a larger number of cases will ultimately result in higher deaths 2 - 8 weeks later.

* The number of active severe cases requiring hospitalization is projected to decrease by {format(-as.numeric(gsub(',', '', npi_hospitalizations_delta_LOW)), big.mark=',')} - {format(-as.numeric(gsub(',', '', npi_hospitalizations_delta_HI)), big.mark=',')} assuming NPIs are maintained, and to still decrease albeit more slowly (by {format(-as.numeric(gsub(',', '', no_npi_hospitalizations_delta_LOW)), big.mark=',')} - {format(-as.numeric(gsub(',', '', no_npi_hospitalizations_delta_HI)), big.mark=',')}) if they are lifted.
"

key_messages_subnational_projections <- "

* In the next two weeks and assuming NPIs are maintained, the situation in the country is projected to worsen in Lower Shabelle, while most other regions will see little change, or slight decreases in incidence. Still, those decreases will not suffice to suppress community spread and most regions will remain at a yellow or worse level of risk (see section 4). 

* The projected incidence indicates a need for more intense control strategies.
"
```

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(knitr)
library(kableExtra)
library(pander)
library(glue)

options(scipen = 999) # effectively remove scientific notation

# country specs
country <- 'Somalia'
country_iso_3_code <- 'SOM'

# report specs
assignment_date <- as.Date(params$assignment_date)

# compute projection dates
projection_date_4w <- assignment_date + 28
projection_date_2w <- assignment_date + 14

# functions
colorize <- function(x, color) {
  if (knitr::is_latex_output()) {
    sprintf("\\textcolor{%s}{%s}", color, x)
  } else if (knitr::is_latex_output()) {
    sprintf("<span style='color: %s;'>%s</span>", color, 
      x)
  } else x
}
```

```{r updated_inputs, echo = FALSE}

# import metrics for the country
report_metrics_filename <- paste0("report_metrics/", country_iso_3_code, "_results.csv")
report_metrics_all_dates <- read.csv(report_metrics_filename)

# keep latest metrics
report_metrics <- report_metrics_all_dates %>% filter(assessment_date == assignment_date)

# case fatality rate
cfr <- report_metrics %>% filter(metric_name == 'CFR') %>% select(metric_value) %>% as.numeric()
cfr <- round(cfr, 1)
cfr_text <- paste0(cfr, '%')

# case reporting rate
crr <- report_metrics %>% filter(metric_name == 'Estimated case reporting rate') %>% select(metric_value) %>% as.numeric()
crr <- round(crr, 1)

# Current Situation MOPH data counts
latest_moph_datapoint_date <- report_metrics %>% filter(metric_name == "Current situation - latest date MPHO reported numbers") %>% select(metric_value) %>% as.character() %>% as.Date("%Y-%m-%d")

mpho_current_cum_cases <- report_metrics %>% filter(metric_name == "Current situation - latest MPHO cases") %>% select(metric_value) %>% as.numeric()
mpho_current_cum_cases <- format(round(mpho_current_cum_cases, 0), big.mark = ",")

mpho_current_cum_deaths <- report_metrics %>% filter(metric_name == "Current situation - latest MPHO deaths") %>% select(metric_value) %>% as.numeric()
mpho_current_cum_deaths <- format(round(mpho_current_cum_deaths, 0), big.mark = ",")

# projected cumulative totals at 4w
npi_projected_cases_4w_LOW <- report_metrics %>% filter(metric_name == "NPI - projected reported cases in 4w - MIN") %>% select(metric_value) %>% as.numeric()
npi_projected_cases_4w_LOW <- format(round(npi_projected_cases_4w_LOW, 0), big.mark = ",")

npi_projected_cases_4w_HI <- report_metrics %>% filter(metric_name == "NPI - projected reported cases in 4w - MAX") %>% select(metric_value) %>% as.numeric()
npi_projected_cases_4w_HI <- format(round(npi_projected_cases_4w_HI, 0), big.mark = ",")

npi_projected_deaths_4w_LOW <- report_metrics %>% filter(metric_name == "NPI - projected reported deaths in 4w - MIN") %>% select(metric_value) %>% as.numeric()
npi_projected_deaths_4w_LOW <- format(round(npi_projected_deaths_4w_LOW, 0), big.mark = ",")

npi_projected_deaths_4w_HI <- report_metrics %>% filter(metric_name == "NPI - projected reported deaths in 4w - MAX") %>% select(metric_value) %>% as.numeric()
npi_projected_deaths_4w_HI <- format(round(npi_projected_deaths_4w_HI, 0), big.mark = ",")

no_npi_projected_cases_4w_LOW <- report_metrics %>% filter(metric_name == "NO NPI - projected reported cases in 4w - MIN") %>% select(metric_value) %>% as.numeric()
no_npi_projected_cases_4w_LOW <- format(round(no_npi_projected_cases_4w_LOW, 0), big.mark = ",")

no_npi_projected_cases_4w_HI <- report_metrics %>% filter(metric_name == "NO NPI - projected reported cases in 4w - MAX") %>% select(metric_value) %>% as.numeric()
no_npi_projected_cases_4w_HI <- format(round(no_npi_projected_cases_4w_HI, 0), big.mark = ",")

no_npi_projected_deaths_4w_LOW <- report_metrics %>% filter(metric_name == "NO NPI - projected reported deaths in 4w - MIN") %>% select(metric_value) %>% as.numeric()
no_npi_projected_deaths_4w_LOW <- format(round(no_npi_projected_deaths_4w_LOW, 0), big.mark = ",")

no_npi_projected_deaths_4w_HI <- report_metrics %>% filter(metric_name == "NO NPI - projected reported deaths in 4w - MAX") %>% select(metric_value) %>% as.numeric()
no_npi_projected_deaths_4w_HI <- format(round(no_npi_projected_deaths_4w_HI, 0), big.mark = ",")

# projected deltas at 4w
npi_projected_deltas_cases_4w_LOW <- report_metrics %>% filter(metric_name == "NPI - projected additional reported cases in 4w - MIN") %>% select(metric_value) %>% as.numeric()
npi_projected_deltas_cases_4w_LOW <- format(round(npi_projected_deltas_cases_4w_LOW, 0), big.mark = ",")

npi_projected_deltas_cases_4w_HI <- report_metrics %>% filter(metric_name == "NPI - projected additional reported cases in 4w - MAX") %>% select(metric_value) %>% as.numeric()
npi_projected_deltas_cases_4w_HI <- format(round(npi_projected_deltas_cases_4w_HI, 0), big.mark = ",")

npi_projected_deltas_deaths_4w_LOW <- report_metrics %>% filter(metric_name == "NPI - projected additional reported deaths in 4w - MIN") %>% select(metric_value) %>% as.numeric()
npi_projected_deltas_deaths_4w_LOW <- format(round(npi_projected_deltas_deaths_4w_LOW, 0), big.mark = ",")

npi_projected_deltas_deaths_4w_HI <- report_metrics %>% filter(metric_name == "NPI - projected additional reported deaths in 4w - MAX") %>% select(metric_value) %>% as.numeric()
npi_projected_deltas_deaths_4w_HI <- format(round(npi_projected_deltas_deaths_4w_HI, 0), big.mark = ",")

no_npi_projected_deltas_cases_4w_LOW <- report_metrics %>% filter(metric_name == "NO NPI - projected additional reported cases in 4w - MIN") %>% select(metric_value) %>% as.numeric()
no_npi_projected_deltas_cases_4w_LOW <- format(round(no_npi_projected_deltas_cases_4w_LOW, 0), big.mark = ",")

no_npi_projected_deltas_cases_4w_HI <- report_metrics %>% filter(metric_name == "NO NPI - projected additional reported cases in 4w - MAX") %>% select(metric_value) %>% as.numeric()
no_npi_projected_deltas_cases_4w_HI <- format(round(no_npi_projected_deltas_cases_4w_HI, 0), big.mark = ",")

no_npi_projected_deltas_deaths_4w_LOW <- report_metrics %>% filter(metric_name == "NO NPI - projected additional reported deaths in 4w - MIN") %>% select(metric_value) %>% as.numeric()
no_npi_projected_deltas_deaths_4w_LOW <- format(round(no_npi_projected_deltas_deaths_4w_LOW, 0), big.mark = ",")

no_npi_projected_deltas_deaths_4w_HI <- report_metrics %>% filter(metric_name == "NO NPI - projected additional reported deaths in 4w - MAX") %>% select(metric_value) %>% as.numeric()
no_npi_projected_deltas_deaths_4w_HI <- format(round(no_npi_projected_deltas_deaths_4w_HI, 0), big.mark = ",")

no_npi_vs_npi_projected_deltas_cases_4W_MAX <- report_metrics %>% filter(metric_name == "Maximum number of extra cases if NPIs are lifted") %>% select(metric_value) %>% as.numeric()
no_npi_vs_npi_projected_deltas_cases_4W_MAX <- format(round(no_npi_vs_npi_projected_deltas_cases_4W_MAX, 0), big.mark = ",")

no_npi_vs_npi_projected_deltas_deaths_4W_MAX <- report_metrics %>% filter(metric_name == "Maximum number of extra deaths if NPIs are lifted") %>% select(metric_value) %>% as.numeric()
no_npi_vs_npi_projected_deltas_deaths_4W_MAX <- format(round(no_npi_vs_npi_projected_deltas_deaths_4W_MAX, 0), big.mark = ",")

# projected hospitalizations at 4w
hospitalizations_current_LOW <- report_metrics %>% filter(metric_name == "Hospitalizations current situation - MIN") %>% select(metric_value) %>% as.numeric()
hospitalizations_current_LOW <- format(round(hospitalizations_current_LOW, 0), big.mark = ",")

hospitalizations_current_HI <- report_metrics %>% filter(metric_name == "Hospitalizations current situation - MAX") %>% select(metric_value) %>% as.numeric()
hospitalizations_current_HI <- format(round(hospitalizations_current_HI, 0), big.mark = ",")

npi_hospitalizations_LOW <- report_metrics %>% filter(metric_name == "NPI Hospitalizations projections 4w - MIN") %>% select(metric_value) %>% as.numeric()
npi_hospitalizations_LOW <- format(round(npi_hospitalizations_LOW, 0), big.mark = ",")

npi_hospitalizations_delta_LOW <- report_metrics %>% filter(metric_name == "NPI additional Hospitalizations projections 4w - MIN") %>% select(metric_value) %>% as.numeric()
npi_hospitalizations_delta_LOW <- format(round(npi_hospitalizations_delta_LOW, 0), big.mark = ",")

npi_hospitalizations_delta_HI <- report_metrics %>% filter(metric_name == "NPI additional Hospitalizations projections 4w - MAX") %>% select(metric_value) %>% as.numeric()
npi_hospitalizations_delta_HI <- format(round(npi_hospitalizations_delta_HI, 0), big.mark = ",")

npi_hospitalizations_HI <- report_metrics %>% filter(metric_name == "NPI Hospitalizations projections 4w - MAX") %>% select(metric_value) %>% as.numeric()
npi_hospitalizations_HI <- format(round(npi_hospitalizations_HI, 0), big.mark = ",")

no_npi_hospitalizations_LOW <- report_metrics %>% filter(metric_name == "NO NPI Hospitalizations projections 4w - MIN") %>% select(metric_value) %>% as.numeric()
no_npi_hospitalizations_LOW <- format(round(no_npi_hospitalizations_LOW, 0), big.mark = ",")

no_npi_hospitalizations_HI <- report_metrics %>% filter(metric_name == "NO NPI Hospitalizations projections 4w - MAX") %>% select(metric_value) %>% as.numeric()
no_npi_hospitalizations_HI <- format(round(no_npi_hospitalizations_HI, 0), big.mark = ",")

no_npi_hospitalizations_delta_LOW <- report_metrics %>% filter(metric_name == "NO NPI additional Hospitalizations projections 4w - MIN") %>% select(metric_value) %>% as.numeric()
no_npi_hospitalizations_delta_LOW <- format(round(no_npi_hospitalizations_delta_LOW, 0), big.mark = ",")

no_npi_hospitalizations_delta_HI <- report_metrics %>% filter(metric_name == "NO NPI additional Hospitalizations projections 4w - MAX") %>% select(metric_value) %>% as.numeric()
no_npi_hospitalizations_delta_HI <- format(round(no_npi_hospitalizations_delta_HI, 0), big.mark = ",")

```

```{r risk_levels, echo = FALSE}

effort_needed_table <- data.frame('level' = c('Red', 'Orange', 'Yellow', 'Green'), 
                                  'incidence' = c('25+', '10-25', '1-10', '<1'), 
                                  'effort' = c('Stay-at-home orders necessary', 
                                               'Strategic choices must be made about which package of non-pharmaceutical interventions to use for control. Stay-at-home orders are advised, unless viral testing and contact tracing capacity are implementable                                                    at levels meeting surge indicator standards.',
                                               'Strategic choices must be made about which package of non-pharmaceutical interventions to use for control',
                                               'On track for containment, conditional on continuing use of viral testing and contact tracing for surveillance and to contain spikes and outbreaks.')
                                               )
```

```{r current_who_data, include = FALSE}
who_current_cum_cases <- report_metrics %>% filter(metric_name == "Current situation - WHO cases most recent") %>% select(metric_value) %>% as.numeric()
who_current_cum_cases <- format(round(who_current_cum_cases, 0), big.mark = ",")

who_current_cum_deaths <- report_metrics %>% filter(metric_name == "Current situation - WHO deaths most recent") %>% select(metric_value) %>% as.numeric()
who_current_cum_deaths <- format(round(who_current_cum_deaths, 0), big.mark = ",")

who_current_newdaily_7daverage_cases <- report_metrics %>% filter(metric_name == "Current situation - WHO daily new cases, 7-day average") %>% select(metric_value) %>% as.numeric()
who_current_newdaily_7daverage_cases <- format(round(who_current_newdaily_7daverage_cases, 1), big.mark = ",")

who_current_newdaily_7daverage_deaths <- report_metrics %>% filter(metric_name == "Current situation - WHO daily new deaths, 7-day average") %>% select(metric_value) %>% as.numeric()
who_current_newdaily_7daverage_deaths <- format(round(who_current_newdaily_7daverage_deaths, 1), big.mark = ",")

```

```{r graphs, include = FALSE}
current_reported_incidence_risk_graph_path <- paste0("../Outputs/", country_iso_3_code, "/map_dailyreportedcases_per_100k_current.png")
current_total_incidence_risk_graph_path <- paste0("../Outputs/", country_iso_3_code, "/map_dailytotalcases_per_100k_current.png") # total = reported (as estimated) * case reporting rate
cum_cases_graph_path <- paste0("../Outputs/", country_iso_3_code, "/current_cumulative_reported_cases.png")
cum_deaths_graph_path <- paste0("../Outputs/", country_iso_3_code, "/current_cumulative_deaths.png")
new_cases_graph_path <- paste0("../Outputs/", country_iso_3_code, "/current_daily_reported_cases.png")
new_deaths_graph_path <- paste0("../Outputs/", country_iso_3_code, "/current_daily_deaths.png")
lifetime_cum_cases_graph_path <- paste0("../Outputs/", country_iso_3_code, "/lifetime_cumulative_reported_cases.png")
lifetime_cum_deaths_graph_path <- paste0("../Outputs/", country_iso_3_code, "/lifetime_cumulative_deaths.png")
lifetime_new_cases_graph_path <- paste0("../Outputs/", country_iso_3_code, "/lifetime_daily_reported_cases.png")
lifetime_new_deaths_graph_path <- paste0("../Outputs/", country_iso_3_code, "/lifetime_daily_deaths.png")
hospitalizations_graph_path <- paste0("../Outputs/", country_iso_3_code, "/projection_hospitalizations.png")
projected_reported_incidence_risk_graph_path <- paste0("../Outputs/", country_iso_3_code, "/map_dailyreportedcases_per_100k_2w.png")
projected_total_incidence_risk_graph_path <- paste0("../Outputs/", country_iso_3_code, "/map_dailytotalcases_per_100k_2w.png")
risk_levels_quadrants_path <- paste0("visual_assets/risk_levels_quadrants.png")

```

```{r subnational_projections_data, include = FALSE}
subnational_full_projections_filename <- paste0("../Bucky_results/", paste0(country_iso_3_code, "_npi"), "/adm1_quantiles.csv")
subnational_full_projections <- read.csv(subnational_full_projections_filename)
subnational_projections_filename <- paste0("../Outputs/", country_iso_3_code, "/ADM1_ranking.csv")
subnational_projections <- read.csv(subnational_projections_filename)
subnational_projections$daily_reported_cases_per_100k_abs_change <- round(as.numeric(subnational_projections$daily_reported_cases_per_100k_abs_change), 2)
subnational_projections$daily_reported_cases_per_100k_inTWOweeks <- round(subnational_projections$daily_reported_cases_per_100k_inTWOweeks, 3)
subnational_projections$daily_cases_total_per_100k_abs_change <- round(as.numeric(subnational_projections$daily_cases_total_per_100k_abs_change), 2)
subnational_projections$daily_cases_total_per_100k_inTWOweeks <- round(subnational_projections$daily_cases_total_per_100k_inTWOweeks, 3)
```

# `r paste(colorize('COVID-19 Projections:', 'centreGreen'), colorize(country, 'centreGreen'))`
#### Report Date: `r format(assignment_date, "%d %b %Y")`    

&nbsp;

This report summarizes the COVID-19 model results for `r country`, developed by the OCHA Centre for Humanitarian Data in partnership with the Johns Hopkins University Applied Physics Laboratory. These projections are based on COVID-19 cases and deaths data up to `r format(assignment_date, format="%d %B %Y")`. The data is sourced from World Health Organization (WHO) and the country's Ministry of Public Health (MOPH). For dynamic updates to this data and more, see the [HDX COVID-19 Map Explorer](https://data.humdata.org/visualization/covid19-humanitarian-operations/#). For additional information, please contact Leonardo Milano at: <leonardo.milano@un.org>.

![](visual_assets/green_horizontal_line.png){height=30px}

\Large \textbf{`r colorize('1. Key Messages', 'centreGreen')`}

\large \textbf{Current Situation} \normalsize (as of `r format(assignment_date, "%d %b %Y")`)
\normalsize
`r glue(key_messages_current_situation)`

\large \textbf{National Projections} \normalsize (in the next 4 weeks or by `r format(projection_date_4w, "%d %b %Y")`)
\normalsize
`r glue(key_messages_national_projections)`

\large \textbf{Subnational Projections} \normalsize (in the next 2 weeks or by `r format(projection_date_2w, "%d %b %Y")`)
\normalsize
`r glue(key_messages_subnational_projections)`

\newpage

\Large \textbf{`r colorize('2. Current Situation', 'centreGreen')`} \normalsize (as of `r format(assignment_date, "%d %b %Y")`)

\large \textbf{`r colorize('Containment Progress', 'centreBlue')`}
\normalsize 

This report leverages a framework to provide guidance in the interpretation of incidence rates so decision-makers can more readily understand how effective the response has been in containing the virus. The framework was devised by experts from the Harvard Global Health Institute, Harvard’s Edmond J. Safra Center for Ethics, and a network of research and policy organizations (more about the collaborative framework [here](https://globalhealth.harvard.edu/key-metrics-for-covid-suppression-researchers-and-public-health-experts-unite-to-bring-clarity-to-key-metrics-guiding-coronavirus-response/)). 

The framework defines risk levels that indicate whether a region is on track for containment and can help decision-makers know where they are at the moment. The levels do not in themselves provide information about how to respond but do communicate the intensity of effort needed for control of COVID at varying levels of community spread. In addition to paying attention to the levels, decision-makers should pay close attention to direction of trend and rate of change (see section 4 for those metrics at the subnational level). 

The map below illustrates regional risk levels as defined by estimated total incidence rate (daily new cases per 100,000 people as of `r format(assignment_date, "%d %b %Y")`). Total cases are estimated from case reporting rate to adjust for underreporting. The table details the cutoffs for each risk level along with strategies of disease response needed for containment.

```{r current_incidence_maps, echo = FALSE, fig.show="hold", out.width="50%",  fig.align='center'}

par(mar = c(4, 4, .1, .1))
#include_graphics(current_reported_incidence_risk_graph_path)
include_graphics(current_total_incidence_risk_graph_path)
```

```{r effort_table, fig.show="hold", out.width="50%", echo = FALSE}

effort_needed_table <- data.frame('level' = c('Red', 'Orange', 'Yellow', 'Green'), 
                                  'incidence' = c('25+', '10-25', '1-10', '<1'), 
                                  'status' = c('Tipping Point', 'Accelerated Spread', 'Community Spread', 'On Track for Containment'),
                                  'effort' = c('Stay-at-home orders necessary', 
                                               'Strategic choices must be made about which package of non-pharmaceutical interventions to use for control. Stay-at-home orders are advised, unless viral testing and contact tracing capacity are implementable                                                    at levels meeting surge indicator standards.',
                                               'Strategic choices must be made about which package of non-pharmaceutical interventions to use for control',
                                               'On track for containment, conditional on continuing use of viral testing and contact tracing for surveillance and to contain spikes and outbreaks.'))


kbl(effort_needed_table, 
    align = 'cccl',
    col.names = c("Risk Level", "Case Incidence*", "Status", "Intensity of Control Effort Needed")) %>%
    add_footnote(c("*Daily new cases per 100,000 people as reported by MOPH", "See \\href{https://globalepidemics.org/wp-content/uploads/2020/09/key_metrics_and_indicators_v5-1.pdf}{Key Metrics for COVID Suppression} for additional guidance on control effort needed."),
                notation = "none", 
                escape = F) %>%
    row_spec(0, bold = TRUE, font_size = 11) %>% 
    kableExtra::kable_styling(latex_options=c("scale_down", "hold_position")) %>%
    column_spec(4, width = "10cm", color = "white") %>%
    column_spec(3, width = "3cm", color = "white") %>%
    column_spec(2, width = "2cm", color = "white") %>%
    column_spec(1, width = "2cm", color = "white") %>%
    row_spec(1, background = "#df431d") %>%
    row_spec(2, background = "#f88c29") %>%
    row_spec(3, background = "#f8b931") %>%
    row_spec(4, background = "#00a67e") 

```

\newpage

\large \textbf{`r colorize('Key Figures: Current Cases and Deaths', 'centreBlue')`}[^1][^2][^3]

```{r section2_cumulative_figures, echo = FALSE, eval = FALSE}

x <- data.frame(Cases = c(mpho_current_cum_cases,who_current_cum_cases),
                Deaths = c(mpho_current_cum_deaths, who_current_cum_deaths)) 

row.names(x) <- c("Based on MOPH data", "Based on WHO data")

x %>% 
            kable(
                  align = 'cc',
                  col.names = c('Cases', 'Deaths'),
                  row.names = TRUE) %>%
            kableExtra::kable_styling(row_label_position = 'r',
                                      position = 'center',
                                      font_size = 11) %>%
            add_header_above(c("","Cumulative" = 2), bold = T, font_size = 12) %>%
            row_spec(0, bold = F, font_size = 12)

```

```{r section2_cumulative_figures_revised, echo = FALSE}

x <- data.frame(NewCases = c('NA', who_current_newdaily_7daverage_cases),
                CumCases = c(mpho_current_cum_cases, who_current_cum_cases),
                NewDeaths = c('NA', who_current_newdaily_7daverage_deaths),
                CumDeaths = c(mpho_current_cum_deaths, who_current_cum_deaths)) 


row.names(x) <- c("Based on MOPH data", "Based on WHO data")

x %>% 
            kable(
                  align = 'cc',
                  col.names = c('Daily New Cases', 'Cumulative', 'Daily New Cases', 'Cumulative'),
                  row.names = TRUE) %>%
            kableExtra::kable_styling(row_label_position = 'r',
                                      position = 'center',
                                      font_size = 11) %>%
            add_header_above(c("","Cases" = 2, "Deaths" = 2), bold = T, font_size = 12) %>%
            row_spec(0, bold = F, font_size = 12)

```


\footnotesize

\begin{center}
"Daily new cases" in this table is the average over the last 7 days.

Most recent data from MOPH: `r latest_moph_datapoint_date`
\end{center}

\large \textbf{`r colorize('Key Figures: Current Severe Cases', 'centreBlue')`}

```{r section2_hospitalization_estimate, echo = FALSE}

x <- data.frame(Hospitalizations = paste0(hospitalizations_current_LOW, " - ", hospitalizations_current_HI))
row.names(x) <- "Estimate"

x %>% 
            kable(format = "latex", 
                  align = 'c',
                  col.names = c('Severe Cases Requiring Hospitalization'),
                  row.names = TRUE) %>%
            kableExtra::kable_styling(row_label_position = 'r',
                                      position = 'center',
                                      font_size = 11) %>%
            add_header_above(c("","Active" = 1), bold = T, font_size = 12) %>%
            row_spec(0, bold = FALSE, font_size = 12) 
```

\large \textbf{`r colorize('Note on data reliability', 'centreBlue')`}

\normalsize 

The limitations of COVID-19 reported data should be taken into consideration when interpreting metrics and projections. Sources may diverge in the counts they report (see WHO vs MOPH figures above); data reports may lag by several days or be missing altogether on certain days (see date of latest data above); cases and deaths are almost certainly underreported and their numbers are affected by testing practices. Scenario modelling (NPI vs non-NPI projections) relies on the freshness and accuracy of the information provided in the ACAPS database (see footnote 3). We strongly encourage the reader to ensure the database is up to date and to contact the Centre for Humanitarian Data with any suggestions of additional data sources or improvements to existing ones.

These are common limitations. This report aims to help the reader understand the situation on the ground through comparing and contrasting multiple data sources and estimates. For instance, we present data reported by the WHO and the MOPH, projected cases and deaths, and incidence of total cases, an estimate of the true number of cases factoring in the case reporting rate (ie., how many cases are likely unreported.) The projections are best estimates based on available data.





[^1]: \textbf{Reported cases} refers to the number of infections expected (current situation) or expected to be reported (projections). Projections take into account the \textbf{case reporting rate} which corresponds to the estimated number of COVID-19 infections that are actually tested, confirmed and reported. The case reporting rate is calculated based on the number of deaths and cases reported by the WHO in the last 30 days.

[^2]: \textbf{Severe cases} refers to the number of people which will have severe symptoms and may require healthcare support. Projections are calculated as a proportion of the reported cases, and are based on planning parameters for case severity and the vulnerability of a given region.

[^3]: \textbf{Case Fatality Rate} refers to the estimated proportion of deaths compared to the total number of people diagnosed with the disease. 

\newpage

\Large \textbf{`r colorize('3. National Projections', 'centreGreen')`}[^4][^5] \normalsize (for the next 4 weeks or by `r format(projection_date_4w, "%d %b %Y")`)

\large \textbf{`r colorize('Projected Cases and Deaths', 'centreBlue')`}


```{r section3_projected_cases_deaths, echo = FALSE}

#x <- data.frame(cum_cases = c(paste(npi_projected_cases_4w_LOW, " - ", npi_projected_cases_4w_HI), 
#                          paste(no_npi_projected_cases_4w_LOW, " - ", no_npi_projected_cases_4w_HI)),
#                cum_deaths = c(paste(npi_projected_deaths_4w_LOW, " - ", npi_projected_deaths_4w_HI), 
#                           paste(no_npi_projected_deaths_4w_LOW, " - ", no_npi_projected_deaths_4w_HI))
#                )

x <- data.frame(delta_cases_4w = c(paste(npi_projected_deltas_cases_4w_LOW, " - ", npi_projected_deltas_cases_4w_HI), 
                          paste(no_npi_projected_deltas_cases_4w_LOW, " - ", no_npi_projected_deltas_cases_4w_HI)),
                delta_deaths_4w = c(paste(npi_projected_deltas_deaths_4w_LOW, " - ", npi_projected_deltas_deaths_4w_HI), 
                           paste(no_npi_projected_deltas_deaths_4w_LOW, " - ", no_npi_projected_deltas_deaths_4w_HI))
                )

row.names(x) <- c("With current NPIs maintained", "With no NPIs")

x %>% 
            kable(format = "latex", 
                  align = 'cc',
                  col.names = c('Added Cases', 'Added Deaths'),
                  row.names = TRUE) %>%
            kableExtra::kable_classic(row_label_position = 'r',
                                      position = 'center',
                                      font_size = 11) %>%
            add_header_above(c("","Change" = 2), bold = T, font_size = 12) %>%
            row_spec(0, bold = F, font_size = 12) %>%
            row_spec(1, color = '#20aa6c') %>%
            row_spec(2, color = '#be0003')

```



[^4]: The regional data provided by the Ministry of Public Health are used to generate projections at the subnational level, which are then aggregated to the national level. 

[^5]: \textbf{Non-pharmaceutical interventions - NPIs} are all measures implemented by different actors with the aim of reducing the spread and the impact of COVID-19. The NPIs currently in place are extracted from the [ACAPS database](https://data.humdata.org/dataset/acaps-covid19-government-measures-dataset) and complemented with additional contextual information provided by our partners in the country. 

\normalsize The figures below present the historical data on daily new cases and deaths, and their projected trends. Trends are represented by a green line for the "Current NPIs maintained" scenario and a red line for the "No NPIs in place" scenario. Note that deaths typically lag reported cases by 2-4 weeks.

![](`r lifetime_new_cases_graph_path`){width=350px} ![](`r lifetime_new_deaths_graph_path`){width=350px}

&nbsp;

The figures below show the comparison between two data sources: national level data from WHO in light blue and subnational data from the Ministry of Public Health in dark blue. 

![](`r lifetime_cum_cases_graph_path`){width=350px} ![](`r lifetime_cum_deaths_graph_path`){width=350px}


\newpage

\large \textbf{`r colorize('Projected Severe Cases', 'centreBlue')`}

\normalsize The figures below show the projected trends for active severe cases requiring hospitalizations. In green are the projections under the "Current NPIs maintained" scenario while in red are the projections under "No NPIs in place" scenario. 

```{r section3_projected_severecases, echo = FALSE}

x <- data.frame(hospitalizations = c(paste(npi_hospitalizations_LOW, " - ", npi_hospitalizations_HI), 
                          paste(no_npi_hospitalizations_LOW, " - ", no_npi_hospitalizations_HI))
                )

row.names(x) <- c("With current NPIs maintained", "With no NPIs")

x %>% 
            kable(format = "latex", 
                  align = 'c',
                  col.names = c('Severe Cases'),
                  row.names = TRUE) %>%
            kableExtra::kable_classic(row_label_position = 'r',
                                      position = 'center',
                                      font_size = 11) %>%
            add_header_above(c("","Active" = 1), bold = T, font_size = 12) %>%
            row_spec(0, bold = F, font_size = 12) %>%
            row_spec(1, color = '#20aa6c') %>%
            row_spec(2, color = '#be0003')
```


\begin{center}
\includegraphics[width=0.5\textwidth]{`r hospitalizations_graph_path`}
\end{center}

\newpage

\Large \textbf{`r colorize('4. Subnational Projections', 'centreGreen')`} \normalsize (for the next 2 weeks or by `r format(projection_date_2w, "%d %b %Y")`)

\large \textbf{`r colorize('Projected Incidence', 'centreBlue')`}

The map below displays the projected risk level of every ADMIN1 region, assuming the current NPIs are maintained. It represents the projected total cases as estimated from case reporting rate to adjust for underreporting. See Section 1 for detail on the relationship between risk level and progress towards virus containment. 


```{r projected_incidence_maps, echo = FALSE, fig.show="hold", out.width="50%",  fig.align='center'}

par(mar = c(4, 4, .1, .1))
#include_graphics(projected_reported_incidence_risk_graph_path)
include_graphics(projected_total_incidence_risk_graph_path)
```


``` {r mini_effort_table, echo = FALSE}
effort_needed_table <- data.frame('level' = c('Red', 'Orange', 'Yellow', 'Green'), 
                                  'status' = c('Tipping Point', 'Accelerated Spread', 'Community Spread', 'On Track for Containment'))
                                  
kbl(effort_needed_table, 
    align = 'cc',
    col.names = c("Risk Level", "Status")) %>%
    row_spec(0, bold = TRUE, font_size = 11) %>% 
kableExtra::kable_styling(position = 'center') %>%
column_spec(2, width = "3cm", color = "white") %>%
column_spec(1, width = "2cm", color = "white") %>%
row_spec(1, background = "#df431d") %>%
row_spec(2, background = "#f88c29") %>%
row_spec(3, background = "#f8b931") %>%
row_spec(4, background = "#00a67e") 
```
&nbsp;

\large \textbf{`r colorize('Projected Changes In Incidence', 'centreBlue')`}

Below are the projected incidence rates (= projected daily new cases per 100k people on `r format(projection_date_2w, "%d %b %Y")`) and projected absolute changes in incidence between then and today for every region. These metrics do not include adjustments for underreporting.

Regions are ordered in decreasing order of change magnitude, from largest increase to largest decrease. Note that Incidence Rates are rounded to the third decimal; therefore a 0.000 incidence rate may mean that no new daily cases are projected or that fewer than 1 cases per 100 million people are projected.

While the magnitude of change may signal how successful mitigation strategies are projected to be, it should be evaluated in conjunction with incidence when considering adding or lifting suppression strategies. For instance, a region may be projected to show a large decrease but remain at a concerning high level of incidence that require intense control efforts. 

```{r subnational_deltas, echo = FALSE}
increases_nrow <- subnational_projections %>%
                          filter(daily_cases_total_per_100k_abs_change >= 0) %>%
                          nrow()

decreases_nrow <- subnational_projections %>%
                          filter(daily_cases_total_per_100k_abs_change < 0) %>%
                          nrow()

subnational_projections_ordered <- subnational_projections %>%
          arrange(desc(daily_cases_total_per_100k_abs_change)) %>% # orders regions from largest to smallest change
          select(admin1RefN, daily_cases_total_per_100k_abs_change, daily_cases_total_per_100k_inTWOweeks)

show_only_increasing_trends <- function(subnational_projections_ordered) {
          subnational_projections_ordered %>%
          mutate(daily_cases_total_per_100k_abs_change = ifelse(daily_cases_total_per_100k_abs_change > 0,
                                                                   paste0('+', daily_cases_total_per_100k_abs_change),
                                                                   daily_cases_total_per_100k_abs_change)) %>%
          kable(format = 'latex',
                col.names = c("Region", "Change", "Incidence"),
                align = "lcc") %>%
          kable_styling(latex_options = c('hold_position', 'repeat_header')) %>%
          column_spec(1, width = "4cm") %>%
          column_spec(2, width = "3.5cm") %>%
          column_spec(3, width = "2cm", background = ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 1, "#00a67e",
                                             ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 10, "#f8b931",
                                                    ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 25, "#f88c29", "#df431d")))) %>%
          add_header_above(c("","Projections in cases per 100k people" = 2), bold = T, font_size = 12) %>%
          pack_rows('Increasing or Stable', 1, increases_nrow, italic = T, indent = T) %>%
          row_spec(0, bold = TRUE, font_size = 12)
}

show_only_decreasing_trends <- function(subnational_projections_ordered) {
          subnational_projections_ordered %>%
          mutate(daily_cases_total_per_100k_abs_change = ifelse(daily_cases_total_per_100k_abs_change > 0,
                                                                   paste0('+', daily_cases_total_per_100k_abs_change),
                                                                   daily_cases_total_per_100k_abs_change)) %>%
          kable(format = 'latex',
                col.names = c("Region", "Change", "Incidence"),
                align = "lcc") %>%
          kable_styling(latex_options = c('hold_position', 'repeat_header')) %>%
          column_spec(1, width = "4cm") %>%
          column_spec(2, width = "3.5cm") %>%
          column_spec(3, width = "2cm", background = ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 1, "#00a67e",
                                             ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 10, "#f8b931",
                                                    ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 25, "#f88c29", "#df431d")))) %>%
          add_header_above(c("","Projections in cases per 100k people" = 2), bold = T, font_size = 12) %>%
          pack_rows('Decreasing', 1, decreases_nrow, italic = T, indent = T) %>%
          row_spec(0, bold = TRUE, font_size = 12)
}    
    
show_both_trends <- function(subnational_projections_ordered) {    
          subnational_projections_ordered %>%
          mutate(daily_cases_total_per_100k_abs_change = ifelse(daily_cases_total_per_100k_abs_change > 0,
                                                                   paste0('+', daily_cases_total_per_100k_abs_change),
                                                                   daily_cases_total_per_100k_abs_change)) %>%
          kable(format = 'latex',
                col.names = c("Region", "Change", "Incidence"),
                align = "lcc") %>%
          kable_styling(latex_options = c('hold_position', 'repeat_header')) %>%
          column_spec(1, width = "4cm") %>%
          column_spec(2, width = "3.5cm") %>%
          column_spec(3, width = "2cm", background = ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 1, "#00a67e",
                                             ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 10, "#f8b931",
                                                    ifelse(subnational_projections_ordered$daily_cases_total_per_100k_inTWOweeks < 25, "#f88c29", "#df431d")))) %>%

          add_header_above(c("","Projections in cases per 100k people" = 2), bold = T, font_size = 12) %>%
          pack_rows(index = c('Increasing or Stable' = increases_nrow, 'Decreasing' = decreases_nrow), italic = T, indent = T) %>%
          row_spec(0, bold = TRUE, font_size = 12)
}
  
if (decreases_nrow == 0) {
  show_only_increasing_trends(subnational_projections_ordered)
  } else if (increases_nrow == 0) {
  show_only_decreasing_trends(subnational_projections_ordered)
  } else {
  show_both_trends(subnational_projections_ordered)
  }

```


\clearpage

\Large \textbf{Background on Model Methodology}
\normalsize

The Centre established a partnership with the Johns Hopkins University Applied Physics Laboratory to develop a COVID-19 model which provides projections and insights related to the **scale** of the crisis, the **duration** of the crisis in a specific location, and how different response **interventions** are expected to impact the epidemic curve.

The team is using an **SEIR (Susceptible, Exposed, Infectious, Recovered)** model of infectious disease dynamics which is considered the simplest and most effective technique used in the literature. The model is based on a progression from susceptible to either recovered or dead. Inputs include the reproduction rate (Ro), case fatality rate (CFR), and estimated probabilities that an individual person may contract COVID-19. The model then simulates an outbreak and provides estimates for cases, severe cases/hospitalizations, and deaths.

\begin{center}
\includegraphics{visual_assets/seird_with_legend.png}
\end{center}

The key features of the model include:

- **Tuning on reported data** The estimation of the main parameters (mainly the reproduction rate R0 and the case reporting rate) is tuned according to the observed recent trends in reported COVID-19 cases.
- **Subnational** The model provides COVID-19 projections at the subnational level, matching the administrative level at which COVID-19 cases are reported.
- **Spatial spread** The density of roads is used to estimate the expected mobility patterns and to simulate the spread of COVID-19 between administrative units.
- **Population stratification** The model fidelity is increased by taking into consideration:
    + The age structure of the population at the subnational level
    + The expected probability of contact between populations of different age groups, including contacts expected to happen at work, school, home and everywhere else (social mixing)
    + Vulnerability factors such as food insecurity and household air pollution.
- **Non-pharmaceutical interventions (NPIs)** The model simulates the expected impact of NPIs at the subnational level, and also how the outbreaks is influenced by changing NPIs implemented over time. The NPIs currently implemented can be categorised in three main groups:
    + Mobility based NPIs, which would limit the spread of disease between administrative units (e.g. border closures)
    + Contact based  NPIs, which reduce the probability of contact between specific groups (e.g. shielding of the elderly, closing schools)
    + R0 based NPIs, which reduce the overall reproduction rate (e.g. awareness campaigns, curfews)
